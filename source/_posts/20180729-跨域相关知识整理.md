---
title: è·¨åŸŸç›¸å…³çŸ¥è¯†æ•´ç†
urlname: KnowledgeAboutCORS
date: 2018-07-29 00:26:31
tags: [CORS]
---

æœ€è¿‘åœ¨é…ç½®Spring Securityçš„æ—¶å€™åœ¨è·¨åŸŸçš„é—®é¢˜ä¸Šåƒäº†ç‚¹äº, é‡åˆ°äº†ä¸€äº›é—®é¢˜, åœ¨è¿™é‡Œæ•´ç†ä¸€ä¸‹, æ˜¯è·¨åŸŸç›¸å…³çŸ¥è¯†çš„ä¸€ç¯‡åŸºç¡€æ–‡.

<!-- more -->

# ä»€ä¹ˆæ˜¯è·¨åŸŸ
è·¨åŸŸ, å³"è·¨åŸŸèµ„æºå…±äº«"(Cross-Origin Resource Sharing, ç¼©å†™ä½œ`CORS`). 
å…³äºCORS, [MDNæ–‡æ¡£ä¸­æœ‰å…³CORSçš„éƒ¨åˆ†](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS)ç»™å‡ºå®šä¹‰ ğŸ‘‡

{%note info%}
å½“ä¸€ä¸ªèµ„æºä»ä¸è¯¥èµ„æºæœ¬èº«æ‰€åœ¨çš„æœåŠ¡å™¨ä¸åŒçš„åŸŸæˆ–ç«¯å£è¯·æ±‚ä¸€ä¸ªèµ„æºæ—¶ï¼Œèµ„æºä¼šå‘èµ·ä¸€ä¸ªè·¨åŸŸ HTTP è¯·æ±‚ã€‚
æ¯”å¦‚ï¼Œç«™ç‚¹`http://domain-a.com`çš„æŸHTMLé¡µé¢é€šè¿‡ `<img>` çš„srcè¯·æ±‚ `http://domain-b.com/image.jpg`ã€‚ç½‘ç»œä¸Šçš„è®¸å¤šé¡µé¢éƒ½ä¼šåŠ è½½æ¥è‡ªä¸åŒåŸŸçš„CSSæ ·å¼è¡¨ï¼Œå›¾åƒå’Œè„šæœ¬ç­‰èµ„æºã€‚
å‡ºäºå®‰å…¨åŸå› ï¼Œæµè§ˆå™¨é™åˆ¶ä»è„šæœ¬å†…å‘èµ·çš„è·¨æºHTTPè¯·æ±‚ã€‚ ä¾‹å¦‚ï¼ŒXMLHttpRequestå’ŒFetch APIéµå¾ªåŒæºç­–ç•¥ã€‚ è¿™æ„å‘³ç€ä½¿ç”¨è¿™äº›APIçš„Webåº”ç”¨ç¨‹åºåªèƒ½ä»åŠ è½½åº”ç”¨ç¨‹åºçš„åŒä¸€ä¸ªåŸŸè¯·æ±‚HTTPèµ„æºï¼Œé™¤éä½¿ç”¨CORSå¤´æ–‡ä»¶ã€‚
{%endnote%}

# ä¸ºä»€ä¹ˆPostManæ¨¡æ‹Ÿçš„è¯·æ±‚ä¸ä¼šæ¶‰åŠè·¨åŸŸ
æœ‰çš„æ—¶å€™ä½ ä¼šå‘ç°, æœ‰äº›è¯·æ±‚ä½ å†™åœ¨å‰ç«¯, åœ¨è®¿é—®è¿›è¡Œè¯·æ±‚çš„æ—¶å€™, ä¼šæŠ¥è·¨åŸŸçš„é”™, è€ŒPostManæ¨¡æ‹ŸåŒæ ·çš„è¯·æ±‚å´ä¸ä¼šæŠ¥é”™, èƒ½å¤ŸæˆåŠŸæ‹¿åˆ°æ•°æ®, è¿™åˆæ˜¯ä¸ºä»€ä¹ˆ?

è·¨åŸŸçš„å®šä¹‰æ˜¯`å½“ä¸€ä¸ªèµ„æºä»ä¸è¯¥èµ„æºæœ¬èº«æ‰€åœ¨çš„æœåŠ¡å™¨ä¸åŒçš„åŸŸæˆ–ç«¯å£è¯·æ±‚ä¸€ä¸ªèµ„æºæ—¶ï¼Œèµ„æºä¼šå‘èµ·ä¸€ä¸ªè·¨åŸŸ HTTP è¯·æ±‚`, æ‰€ä»¥ä½ çŸ¥é“äº†, PostManä¹‹æ‰€ä»¥ä¸ä¼šæœ‰è·¨åŸŸçš„é—®é¢˜æ˜¯å› ä¸ºå®ƒçš„æ¯ä¸€ä¸ªè¯·æ±‚éƒ½æ˜¯å•ä¸€çš„, éƒ½æ˜¯æœ¬åœ°ç›´æ¥å‘åç«¯æœåŠ¡å™¨å‘å‡ºçš„ä¸€ä¸ªè¯·æ±‚, ä½†æ˜¯å¦‚æœä½ å†™åœ¨å‰ç«¯é‡Œ, å†åˆ°æµè§ˆå™¨ä¸­å»è¯·æ±‚, é‚£ä¹ˆæµè§ˆå™¨å°±ä¼šè®¤ä¸ºä½ ç°åœ¨æ˜¯åœ¨ä¸€ä¸ªç½‘ç«™å‘åç«¯æœåŠ¡å™¨(åç«¯çš„åŸŸè‚¯å®šä¸ä¼šä¸å½“å‰ç«¯çš„åŸŸç›¸åŒå§, å› ä¸ºå°±ç®—ipåœ°å€ä¸€æ ·, ç«¯å£ä¹Ÿè‚¯å®šä¸ä¸€æ ·,å½“ç„¶äº†, ç°åœ¨è¯´çš„æ˜¯å‰åç«¯åˆ†ç¦»çš„æƒ…å†µ)è¯·æ±‚, æ‰€ä»¥è¿™å°±æ˜¯è·¨åŸŸ.


# HTTPçš„OPTIONSæ–¹æ³•
* ğŸ‘‰ [MDNæ–‡æ¡£å…³äºOPTIONSæ–¹æ³•çš„ä»‹ç»](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/OPTIONS)

* [MDNæ–‡æ¡£ä¸­æœ‰å…³CORSçš„éƒ¨åˆ†](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS)æåŠOPTIONSæ–¹æ³•, å¦‚æ˜¯è¯´ ğŸ‘‡

{%note info%}
è·¨åŸŸèµ„æºå…±äº«æ ‡å‡†æ–°å¢äº†ä¸€ç»„ HTTP é¦–éƒ¨å­—æ®µï¼Œå…è®¸æœåŠ¡å™¨å£°æ˜å“ªäº›æºç«™æœ‰æƒé™è®¿é—®å“ªäº›èµ„æºã€‚å¦å¤–ï¼Œè§„èŒƒè¦æ±‚ï¼Œå¯¹é‚£äº›å¯èƒ½å¯¹æœåŠ¡å™¨æ•°æ®äº§ç”Ÿå‰¯ä½œç”¨çš„ HTTP è¯·æ±‚æ–¹æ³•ï¼ˆç‰¹åˆ«æ˜¯ GET ä»¥å¤–çš„ HTTP è¯·æ±‚ï¼Œæˆ–è€…æ­é…æŸäº› MIME ç±»å‹çš„ POST è¯·æ±‚ï¼‰ï¼Œ`æµè§ˆå™¨å¿…é¡»é¦–å…ˆä½¿ç”¨ OPTIONS æ–¹æ³•å‘èµ·ä¸€ä¸ªé¢„æ£€è¯·æ±‚`ï¼ˆpreflight requestï¼‰ï¼Œä»è€Œè·çŸ¥æœåŠ¡ç«¯æ˜¯å¦å…è®¸è¯¥è·¨åŸŸè¯·æ±‚ã€‚æœåŠ¡å™¨ç¡®è®¤å…è®¸ä¹‹åï¼Œæ‰å‘èµ·å®é™…çš„ HTTP è¯·æ±‚ã€‚åœ¨é¢„æ£€è¯·æ±‚çš„è¿”å›ä¸­ï¼ŒæœåŠ¡å™¨ç«¯ä¹Ÿå¯ä»¥é€šçŸ¥å®¢æˆ·ç«¯ï¼Œæ˜¯å¦éœ€è¦æºå¸¦èº«ä»½å‡­è¯ï¼ˆåŒ…æ‹¬ Cookies å’Œ HTTP è®¤è¯ç›¸å…³æ•°æ®ï¼‰ã€‚
{%endnote%}

å› æ­¤ä½ å¦‚æœæƒ³è¦åœ¨è¿›è¡Œç›¸å…³æ“ä½œçš„è¯, å¿…é¡»è¦å°†`OPTIONS`è¯·æ±‚æ–¹æ³•æ”¾å¼€, å¦åˆ™æ— æ³•è¿›è¡Œæ“ä½œ.  å¦‚åœ¨SpringBootä¸­ä½¿ç”¨Securityçš„è¯, å¯ä»¥åœ¨Securityçš„é…ç½®(ä¾‹å¦‚åœ¨[åˆè¯•Spring Security](https://blog.safeandsound.cn/post/Introduction2SpringSecurity.html)ä¸€æ–‡ä¸­çš„`SecurityConfig`ç±»çš„`configure`æ–¹æ³•)ä¸­æ·»åŠ æ”¾å¼€è§„åˆ™ ğŸ‘‡

```
.antMatchers(HttpMethod.OPTIONS, "/**").permitAll()
```

# SpringBooté¡¹ç›®é…ç½®CORS
è¿™é‡Œè¿˜æ˜¯ä»¥[åˆè¯•Spring Security](https://blog.safeandsound.cn/post/Introduction2SpringSecurity.html)ä¸€æ–‡ä¸­çš„é¡¹ç›®ä¸ºä¾‹.

æˆ‘ä»¬è¦å®ç°`javax.servlet.Filter`æ¥å£çš„CORSè¿‡æ»¤å™¨æ˜¯ç”¨æ¥è®¾ç½®è·¨åŸŸç›¸å…³é…ç½®çš„, ä»£ç ç±»ä¼¼å¦‚ä¸‹, è¿™é‡Œæˆ‘å«ä»–`CORSFilter`:

```
package cn.edu.upc.eduroamcontrolsystembackend.config;

import org.springframework.stereotype.Component;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import javax.servlet.*;

@Component
public class CORSFilter implements javax.servlet.Filter {
    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        HttpServletResponse response = (HttpServletResponse) servletResponse;
        response.setHeader("Access-Control-Allow-Origin", "*");
        response.setHeader("Access-Control-Allow-Methods", "POST, GET, OPTIONS, DELETE");
        response.setHeader("Access-Control-Max-Age", "3600");
        response.setHeader("Access-Control-Allow-Headers", "X-Requested-With, Authorization");
        response.setHeader("Access-Control-Allow-Credentials", "true");
        filterChain.doFilter(servletRequest, servletResponse);
    }

    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
    }

    @Override
    public void destroy() {
    }
}
```

è¯·æ³¨æ„`response.setHeader("Access-Control-Allow-Headers", "X-Requested-With, Authorization");`ä»£ç ä¸­çš„`Authorization`, è¯¥headerå­—æ®µä¸ºé¡¹ç›®ä¸­è®¾ç½®çš„tokençš„å­—æ®µ, ä¾‹å¦‚åˆ·æ–°token, åˆ™æ˜¯å°†tokenæ”¾å…¥headerçš„Authorizationå­—æ®µä¸­æäº¤ç»™åç«¯, å¦‚æœä¸æ·»åŠ è¯¥å­—æ®µçš„è¯, åç«¯ä¼šç›´æ¥å°†è¯·æ±‚è¿‡æ»¤æ‰, å› ä¸ºå‰ç«¯æäº¤çš„è¯·æ±‚ä¸­åŒ…å«äº†åç«¯æ‰€æ²¡æœ‰å…è®¸çš„header, å¯¼è‡´å‰ç«¯ä¼šæŠ¥`Request header field Content-Type is not allowed by Access-Control-Allow-Headers in preflight response.`çš„é”™è¯¯.