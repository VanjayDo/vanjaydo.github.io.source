---
title: 关于DNS的一些知识整理
urlname: SomeKnowledgePointsAboutDNS
date: 2017-11-11 16:28:53
tags: [DNS, Network]
---

今天在腾讯云上对于域名的解析存在点问题，在腾讯云上发了条工单并查了下DNS解析相关的内容，虽说专业网络课程上有讲到过，但只是简单提及，这里作为补充。

<!--more-->

### 基本解析过程
对于域名解析的过程我们都知道，我在网上找了一个比较详细的过程并进行了简单修改（[原文在此](http://www.ityouknow.com/arch/2017/02/09/a-tragedy-caused-by-dns-cache.html)）：
当你在浏览器输入一个域名地址回车请求后，

* `第 1 步`：浏览器会检查缓存中有没有这个域名的IP地址映射，如果有该解析过程将会结束。浏览器缓存域名也是有限制的，包括缓存的时间、大小，可以通过TTL属性来设置。（各大浏览器都默认开启DNS缓存，用户可以进行操作，详细过程参考该博文：[浏览器的DNS缓存](http://www.cnblogs.com/tonykan/p/3500332.html)）

* `第2步`：如果浏览器缓存中没有，操作系统会先检查自己本地的hosts文件（Windows下是C:\Windows\System32\drivers\etc\hosts，Linux下是/etc/hosts）是否有这个地址映射，如果有，就先调用，完成解析。

* `第 3 步`：如果hosts里没有这个域名的映射，则查找本地DNS缓存中是否有这个地址映射，如果有则直接返回，完成解析。

* `第 4 步`：如果hosts与本地DNS缓存都没有相应的网址映射关系，系统首先会找本地DNS服务器进行查询，此服务器收到查询时，如果要查询的域名包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析，此解析具有权威性。

* `第 5 步`：如果要查询的域名，不由本地DNS进行区域解析，但该服务器已缓存了此网址映射关系，则调用这个IP地址映射，完成域名解析，此解析不具有权威性。

* `第 6 步`：如果本地DNS的区域文件与缓存解析都失效，则根据本地DNS的设置（是否设置转发器）进行查询，如果未用转发模式，本地DNS就把请求发至13台根DNS，根DNS收到请求后会判断这个顶级域名(例如.com，下面以.com为例)是谁来授权管理，并会返回一个负责该顶级域名服务器的一个IP（<i style="color:red;font-style:normal">这里注意，根DNS并不缓存地址映射，它们直接返回管辖相应域的DNS的ip地址</i>）。本地DNS收到IP信息后，将会联系负责.cn域的这台服务器。这台负责.com域的服务器收到请求后，如果自己无法解析，它就会找一个管理.com域的下一级DNS地址给本地DNS。当本地DNS收到这个地址后，就会找该地址的服务器，重复上面的动作，进行查询，直至找到域名对应的主机。

* `第 7 步`：如果用的是转发模式，此DNS服务器就会把请求转发至上一级DNS服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根DNS或把转请求转至上上级，以此循环。不管是本地DNS服务器用是是转发，还是根提示，最后都是把结果返回给本地DNS服务器，由此DNS服务器再返回给客户机。

**注：**`第 6 步`中所谓的未用转发模式也就是迭代查询，客户机得到的是下一个DNS的地址，需要不断查询，最终得到结果；`第 7 步`中所谓的转发模式也就是递归查询，多次的查询请求在DNS之间进行，客户机得到的是解析结果。

### 我通过工单了解到了什么
关于添加自己的域名解析，比如我在腾讯云的域名解析控制台添加了自己safeandsound.cn域名的一条A记录，那么腾讯到底做了什么？

用户在提交自己域名的一条解析后，域名商那边会将新增/修改的域名解析记录提交到自己的域名服务器，并将TTL设置为你选定的值。

拥有提交记录到根域名服务器的机构是需要事先通过ICANN官方认证的。

### 关于TTL
该值与ip协议中的TTL并非一个概念，但是有相同之处，它是域名解析记录在DNS服务器的生存时间（当DNS服务器收到域名解析请求时，会先检查本地是否有记录，有记录则直接返回，无则递归向上请求解析；在获得解析记录后，这条记录会在该服务器上保存一段时间，这个保留时间就是TTL值【单位为秒】，在超过这个值后，服务器会丢弃这条记录重新主动请求）。关于TTL值的设置，一般默认是600，也就是十分钟，如果页面不经常变动的话可以设置的长一点，这样DNS就不会经常去请求解析直接利用缓存，可以让服务更稳定（提升的程度有限）不建议超过24小时，否则更新后的解析记录同步到全球DNS的时间会比较长；如果要求各地DNS能更快的得到更新的记录那就将TTL设置的小一点,建议先将TTL值设小，等估计各地的DNS更新完后再将TTL改大些。一般推荐的值是600~86400，即10分钟到24小时。
