---
title: 关于DNS的一些知识整理
urlname: SomeKnowledgePointsAboutDNS
date: 2017-11-11 16:28:53
tags: [DNS, Network]
---

今天在腾讯云上对于域名的解析存在点问题，在腾讯云上发了条工单并查了下DNS解析相关的内容。虽说专业网络课程上有讲到过，但只是简单提及，这里作为补充。

2018-10-02更新：之前准备考研看了王道的CS考研复习指导，感觉计算机网络一书中关于DNS部分的内容整理得挺详细的，所以添加进来更新一下。

<!--more-->

# 一. 基础概念
DNS系统采用C/S模型，其协议运行在UDP之上，使用53端口。概念上可以将DNS分为三个部分：层次域名系统、域名服务器和解析器。

## 层次域名系统
因特网使用层次树状结构的命名方法。

顶级域名（Top Level Domain，TLD）有三类：
1. 国家顶级域名，nTLD，国家和某些地区的域名，如，`.cn`表示中国，`.us`表示美国，`.hk`表示中国香港特区；
2. 通用顶级域名，gTLD，常见的有`.com`（公司企业）， `.net`(网络服务机构)，`.org`（非盈利组织）、`.gov`（美国政府部门）等；
3. 基础结构余名，这个顶级域名只有一个，即`arpa`，用于反向解析域名，因此又称为反向域名；

国家顶级域名下注册的二级域名均由该国家自行确定。

在域名系统中，每个域分别由不同的组织进行管理，每个组织都可以将它的域再分成一定的子域并将这些子域委托给其他组织去管理。如，管理`cn`域的中国将`edu.cn`子域授权给中国教育和科研计算机网CERNET来管理。

## 域名服务器
因特网的域名系统被设计为一个联机分布式的数据库系统，并采用了C/S模型。域名到IP地址的解析是由运行在域名服务器上的程序完成的，一个服务器所负责管辖的范围称为区（不是以“域“为单位），各单位根据具体情况来划分自己管辖范围的区，但在一个区中的所有节点必须是能够连通的，每个区设置相应的权限域名服务器，用来保存该区中的所有主机的域名到IP地址的映射。每一个域名服务器不但能够进行一些域名到IP地址的解析，而且必须具有连向其他域名服务器的信息。当自己不能域名到IP地址的转换时，能够知道到什么地方去找别的域名服务器。

DNS使用了大量的域名服务器，它们以层次方式组织。没有一台域名服务器具有因特网上所有主机的映射，相反，该映射分布在所有的DNS服务器上。采用分布式设计的DNS系统是一个在因特网上实现分布式数据库的精彩范例。

主要有四种类型的域名服务器：👇

### 1. 根域名服务器
[根域名服务器](https://zh.wikipedia.org/wiki/根網域名稱伺服器)是最高层次的域名服务器，所有的根域名服务器都知道所有的顶级域名服务器的IP地址，根域名服务器也是最重要的域名服务器，不管是哪一个本地域名服务器，若要对因特网上任何一个域名进行解析，只要自己无法解析，就首先求助于根域名服务器。因特网上有着13个根域名服务器，尽管我们将这13个根域名服务器中的每个都视为单个的服务器，但是每台”服务器“都实际上是冗余服务器的集群，以提供安全性和可靠性。需要注意的是，根域名服务器用来管辖顶级域（如`.com`），通常它并不直接将待查询的域名直接转换为IP地址，而是告诉本地域名服务器下一步应该找哪一个顶级域名服务器进行查询。


### 2. 顶级域名服务器
这些顶级域名服务器负责管理在该顶级域名服务器注册的所有二级域名。

当收到DNS查询请求时，就给出相应的回答（可能是最后的结果，也可能下一步应当查找的域名服务器的IP地址）。

### 3. 授权域名服务器（权限域名服务器）
每一个主机都必须授权域名服务器处登记。为了更加可靠的工作，一个主机最好至少有两个授权域名服务器。实际上，许多域名服务器都同时充当着本地域名服务器和授权域名服务器。授权域名服务器总是能够将其管辖的主机名转换为该主机的IP地址。

### 4. 本地域名服务器
本地域名服务器对域名系统非常重要，每一个因特网服务提供者ISP，或一个大学，甚至一个大学里的系，都可以拥有一个本丢域名服务器，当一个主机发出DNS查询请求时，这个查询请求报文就发送给该主机的本地域名服务器。事实上，我们在Windows系统中配置”本地连接“时，就需要填写DNS服务器地址，这个地址就是本地DNS域名服务器地址。


# 二. 域名解析过程
域名解析是指把域名映射为IP地址或把IP地址映射为域名的过程。前者成为正向解析，后者称为反向解析。

域名解析有两种方式：`递归查询`和`递归与迭代的相结合的查询`。

`递归查询`：多次的查询请求在DNS服务器之间进行，客户机得到的是解析结果。

`迭代查询`：客户机得到的是下一个DNS的地址，需要客户机不断的发出查询请求，最终得到结果。

## 常用查询方式
常用递归与迭代相结合的查询方式，该方式分为两个部分：👇 

### 1.主机向本地域名服务器的查询采用的是递归查询

也就是说，如果本地主机所查询的本地服务器不知道查被查询域名的IP地址，那么本地域名服务器就以DNS客户的身份，向根域名服务器继续发送查询请求报文（即替该主机继续查询），而不是让该主机自己进行下一步的查询。在这种情况下，本地域名服务器只需要向根域名服务器查询一次，后面的几次查询都是递归的在其他几个域名服务器之间进行的。本地域名服务器最终从根域名服务器得到了所需的IP地址，最后将查询结果告诉发起查询的本地主机。

### 2.本地域名服务器向根域名服务器的查询采用迭代查询

当根域名服务器收到本地域名服务器发出的迭代查询请求报文时，要么给出所要查询的IP地址，要么告诉本地域名服务器：“你下一步应该向哪一个顶级域名服务器进行查询”。然后让本地域名服务器向这个顶级域名服务器发起后续的查询。同样，顶级域名服务器收到查询报文后，要么给出所要查询的IP地址，要么告诉本地域名服务器下一步应该向哪一个权限域名服务器查询......如此下去，最后本地域名服务器知道了所要解析的域名的IP地址，将结果返回给发起查询的本地主机。

## 基本解析过程
对于域名解析的过程我们都知道，我在网上找了一个比较详细的过程并进行了简单修改（[原文在此](http://www.ityouknow.com/arch/2017/02/09/a-tragedy-caused-by-dns-cache.html)）：
当你在浏览器输入一个域名地址回车请求后，

* `第 1 步`：浏览器会检查缓存中有没有这个域名的IP地址映射，如果有该解析过程将会结束。浏览器缓存域名也是有限制的，包括缓存的时间、大小，可以通过TTL属性来设置。（各大浏览器都默认开启DNS缓存，用户可以进行操作，详细过程参考该博文：[浏览器的DNS缓存](http://www.cnblogs.com/tonykan/p/3500332.html)）

* `第2步`：如果浏览器缓存中没有，操作系统会先检查自己本地的hosts文件（Windows下是C:\Windows\System32\drivers\etc\hosts，Linux下是/etc/hosts）是否有这个地址映射，如果有，就先调用，完成解析。

* `第 3 步`：如果hosts里没有这个域名的映射，则查找本地DNS缓存中是否有这个地址映射，如果有则直接返回，完成解析。

* `第 4 步`：如果hosts与本地DNS缓存都没有相应的网址映射关系，系统首先会找本地DNS服务器进行查询，此服务器收到查询时，如果要查询的域名包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析，此解析具有权威性。

* `第 5 步`：如果要查询的域名，不由本地DNS进行区域解析，但该服务器已缓存了此网址映射关系，则调用这个IP地址映射，完成域名解析，此解析不具有权威性。

* `第 6 步`：如果本地DNS的区域文件与缓存解析都失效，则根据本地DNS的设置（是否设置转发器）进行查询，如果未用转发模式（也就是使用递归查询模式），本地DNS就把请求发至13台根DNS，根DNS收到请求后会判断这个顶级域名(例如.com，下面以.com为例)是谁来授权管理，并会返回一个负责该顶级域名服务器的一个IP（<i style="color:red;font-style:normal">这里注意，根DNS并不缓存地址映射，它们直接返回管辖相应域的DNS的ip地址</i>）。本地DNS收到IP信息后，将会联系负责.cn域的这台服务器。这台负责.com域的服务器收到请求后，如果自己无法解析，它就会找一个管理.com域的下一级DNS地址给本地DNS。当本地DNS收到这个地址后，就会找该地址的服务器，重复上面的动作，进行查询，直至找到域名对应的主机。

* `第 7 步`：如果用的是转发模式（也就是使用迭代查询模式），此DNS服务器就会把请求转发至上一级DNS服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根DNS或把转请求转至上上级，以此循环。不管是本地DNS服务器用是是转发，还是根提示，最后都是把结果返回给本地DNS服务器，由此DNS服务器再返回给客户机。

# 三. 我通过工单了解到了什么
关于添加自己的域名解析，比如我在腾讯云的域名解析控制台添加了自己safeandsound.cn域名的一条A记录，那么腾讯到底做了什么？

用户在提交自己域名的一条解析后，域名商那边会将新增/修改的域名解析记录提交到自己的域名服务器，并将TTL设置为你选定的值。

拥有提交记录到根域名服务器的机构是需要事先通过ICANN官方认证的。

# 四. 关于TTL
该值与ip协议中的TTL并非一个概念，但是有相同之处，它是域名解析记录在DNS服务器的生存时间（当DNS服务器收到域名解析请求时，会先检查本地是否有记录，有记录则直接返回，无则递归向上请求解析；在获得解析记录后，这条记录会在该服务器上保存一段时间，这个保留时间就是TTL值【单位为秒】，在超过这个值后，服务器会丢弃这条记录重新主动请求）。关于TTL值的设置，一般默认是600，也就是十分钟，如果页面不经常变动的话可以设置的长一点，这样DNS就不会经常去请求解析直接利用缓存，可以让服务更稳定（提升的程度有限）不建议超过24小时，否则更新后的解析记录同步到全球DNS的时间会比较长；如果要求各地DNS能更快的得到更新的记录那就将TTL设置的小一点,建议先将TTL值设小，等估计各地的DNS更新完后再将TTL改大些。一般推荐的值是600~86400，即10分钟到24小时。
